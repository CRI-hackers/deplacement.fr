<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="utf-8" />
    <script src="https://unpkg.com/pdf-lib"></script>
    <script src="qrcode.min.js"></script>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">  </head>

  <body>
<div class="container">
    <h1 class="titre-2">The Ministry of LOLz presents: Your quick attestation!</h1>

        <form id="form-profile">
          <p class="text-center mt-5">
            <button type="submit" class="btn btn-primary btn-attestation"> <span class="btn-text">Make <i>Get out of Jail</i> card.</span></button>
            <a href='#' id='set-location' class="btn btn-warning btn-attestation"> <span class="btn-text">Current GPS location as home!</span></a>
            <a href='#' id='set-defaults' class="btn btn-danger btn-attestation"> <span class="btn-text">Reset defaults.</span></a>
        </p>

            <div class="form-group"> <label for="field-firstname" id="field-firstname-label">First Name</label>
                <div class="input-group align-items-center"> <input type="text" class="form-control" id="field-firstname" name="firstname" autocomplete="given-name" placeholder="Jean" aria-labelledby="field-firstname-label" required="" autofocus=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-lastname" id="field-lastname-label">Last Name</label>
                <div class="input-group align-items-center"> <input type="text" class="form-control" id="field-lastname" name="lastname" autocomplete="family-name" placeholder="Dupont" aria-labelledby="field-lastname-label" required="" autofocus=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-birthday" id="field-birthday-label">Date of Birth (DD/MM/YYYY)</label>
                <div class="input-group align-items-center"> <input type="text" inputmode="numeric" class="form-control" id="field-birthday" name="birthday" autocomplete="bday" placeholder="01/01/1970" maxlength="10" aria-labelledby="field-birthday-label" required=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-lieunaissance" id="field-lieunaissance-label">Born in…</label>
                <div class="input-group align-items-center"> <input type="text" class="form-control" id="field-lieunaissance" name="lieunaissance" aria-labelledby="field-lieunaissance-label" placeholder="Lyon" required=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-address" id="field-address-label">Address</label>
                <div class="input-group align-items-center"> <input type="text" class="form-control" id="field-address" name="address" autocomplete="address-line1" aria-labelledby="field-address-label" placeholder="999 avenue de france" required=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-town" id="field-town-label">City</label>
                <div class="input-group align-items-center"> <input type="text" class="form-control" id="field-town" name="town" autocomplete="address-level1" aria-labelledby="field-town-label" placeholder="Paris" required=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <div class="form-group"> <label for="field-zipcode" id="field-zipcode-label">Zip Code</label>
                <div class="input-group align-items-center"> <input type="number" min="00000" max="99999" class="form-control" id="field-zipcode" name="zipcode" autocomplete="zipcode" minlength="4" maxlength="5" aria-labelledby="field-zipcode-label" placeholder="75001" required=""> <span class="validity"></span> </div>
                <p class="exemple"></p>
            </div>
            <h3>Getting out of jail, because…</h3>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-travail" value="travail"> <label class="form-check-label" for="checkbox-travail">…I gotta work.</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-courses" value="courses"> <label class="form-check-label" for="checkbox-courses">…I need more toilet paper & pasta</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-sante" value="sante"> <label class="form-check-label" for="checkbox-sante">…urgent medical care.</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-famille" value="famille"> <label class="form-check-label" for="checkbox-famille">…of the family.</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-sport" value="sport"> <label class="form-check-label" for="checkbox-sport">…I and/or my dog really need some fun.</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-judiciaire" value="judiciaire"> <label class="form-check-label" for="checkbox-judiciaire">…judicial or administrative reasons..</label> </div>
            <div class="form-check"> <input class="form-check-input" type="checkbox" name="field-reason" id="checkbox-missions" value="missions"> <label class="form-check-label" for="checkbox-missions">…a mission of public interest, I guess?</label> </div>
            <div class="form-group"> <label for="field-datesortie">Date</label>
                <div class="input-group align-items-center"> <input type="date" class="form-control" id="field-datesortie" name="datesortie" placeholder="JJ/MM/YYYY" required=""> <span class="validity"></span> </div>
            </div>
            <div class="form-group"> <label for="field-heure">Time</label>
                <div class="input-group align-items-center"> <input type="time" class="form-control" id="field-heuresortie" name="heure" required=""> <span class="validity"></span> </div>
            </div>
        </form>
</div>
      </body>

    <script>
      const $ = (...args) => document.querySelector(...args)
      const $$ = (...args) => [...document.querySelectorAll(...args)]
      var year, month, day

      const generateQR = async text => {
        try {
          var opts = {
            errorCorrectionLevel: 'M',
            type: 'image/png',
            quality: 0.92,
            margin: 1,
          }
          return await QRCode.toDataURL(text, opts)
        } catch (err) {
          console.error(err)
        }
      }

      function pad (str) {
        return String(str).padStart(2, '0')
      }

      function setDateNow (date) {
        year = date.getFullYear()
        month = pad(date.getMonth() + 1) // Les mois commencent Ã  0
        day = pad(date.getDate())
      }

      document.addEventListener('DOMContentLoaded', setReleaseDateTime)
      document.addEventListener('DOMContentLoaded', setPerson)

      function setPerson () {
        fetch('attestation_config.json').then(
          data=>{return data.json()}).then(res=>{
            document.getElementById('field-firstname').value=res['name'];
            document.getElementById('field-lastname').value=res['last_name'];
            document.getElementById('field-birthday').value=res['dob'];
            document.getElementById('field-lieunaissance').value=res['from'];
            document.getElementById('field-address').value=res['address'];
            document.getElementById('field-town').value=res['city'];
            document.getElementById('field-zipcode').value=res['zipcode'];
            res['reasons'].split("-").forEach(reason => {
              var reason_id = "checkbox-" + reason;
              console.log(reason_id)
              document.getElementById(reason_id).checked = true;
            })
          })
      }


      function setLocation () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
          }
      }

      function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`).then(
          data=>{return data.json()}).then(res=>{
            const road = res['address']['road'];
            const number = res['address']['house_number'];
            const city = res['address']['city'];
            const postcode = res['address']['postcode'];
            document.getElementById('field-address').value=`${number} ${road}`;
            document.getElementById('field-town').value=`${city}`;
            document.getElementById('field-zipcode').value=`${postcode}`;

          })
        }


      function setReleaseDateTime () {
        const loadedDate = new Date()
        setDateNow(loadedDate)
        const releaseDateInput = document.querySelector('#field-datesortie')
        releaseDateInput.value = `${year}-${month}-${day}`

        const time_offset = -25*60*1000
        var loadedTime = new Date(loadedDate.getTime() + time_offset)



        const hour = pad(loadedTime.getHours())
        const minute = pad(loadedTime.getMinutes())

        const releaseTimeInput = document.querySelector('#field-heuresortie')
        releaseTimeInput.value = `${hour}:${minute}`
      }

      function saveProfile () {
        for (const field of $$('#form-profile input')) {
          if (field.id === 'field-datesortie') {
            var dateSortie = field.value.split('-')
            localStorage.setItem(field.id.substring('field-'.length), `${dateSortie[2]}/${dateSortie[1]}/${dateSortie[0]}`)
          } else {
            localStorage.setItem(field.id.substring('field-'.length), field.value)
          }
        }
      }

      function getProfile () {
        const fields = {}
        for (let i = 0; i < localStorage.length; i++) {
          const name = localStorage.key(i)
          fields[name] = localStorage.getItem(name)
        }
        return fields
      }

      function idealFontSize (font, text, maxWidth, minSize, defaultSize) {
        let currentSize = defaultSize
        let textWidth = font.widthOfTextAtSize(text, defaultSize)

        while (textWidth > maxWidth && currentSize > minSize) {
          textWidth = font.widthOfTextAtSize(text, --currentSize)
        }

        return (textWidth > maxWidth) ? null : currentSize
      }

      async function generatePdf (profile, reasons) {
        var generatedDate = new Date()
        setDateNow(generatedDate)
        const creationDate = `${day}/${month}/${year}`

        const time_offset = -25*60*1000
        var generatedDate = new Date(generatedDate.getTime() + time_offset)

        const hour = pad(generatedDate.getHours())
        const minute = pad(generatedDate.getMinutes())
        //const creationHour = `${hour}h${minute}`

        const { lastname, firstname, birthday, lieunaissance, address, zipcode, town, datesortie, heuresortie } = profile
        const releaseHours = String(heuresortie).substring(0, 2)
        const releaseMinutes = String(heuresortie).substring(3, 5)
        const creationHour = `${releaseHours}h${releaseMinutes}`
        const data = [
          `Cree le: ${creationDate} a ${creationHour}`,
          `Nom: ${lastname}`,
          `Prenom: ${firstname}`,
          `Naissance: ${birthday} a ${lieunaissance}`,
          `Adresse: ${address} ${zipcode} ${town}`,
          `Sortie: ${datesortie} a ${releaseHours}h${releaseMinutes}`,
          `Motifs: ${reasons}`,
        ].join('; ')

        const existingPdfBytes = await fetch('./certificate.pdf').then(res => res.arrayBuffer())

        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes)
        const page1 = pdfDoc.getPages()[0]

        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica)
        const drawText = (text, x, y, size = 11) => {
          page1.drawText(text, { x, y, size, font })
        }

        drawText(`${firstname} ${lastname}`, 123, 686)
        drawText(birthday, 123, 661)
        drawText(lieunaissance, 92, 638)
        drawText(`${address} ${zipcode} ${town}`, 134, 613)
        console.log(reasons);
        if (reasons.includes('travail')) {
          drawText('x', 76, 527, 19)
        }
        if (reasons.includes('courses')) {
          drawText('x', 76, 478, 19)
        }
        if (reasons.includes('sante')) {
          drawText('x', 76, 436, 19)
        }
        if (reasons.includes('famille')) {
          drawText('x', 76, 400, 19)
        }
        if (reasons.includes('sport')) {
          drawText('x', 76, 345, 19)
        }
        if (reasons.includes('judiciaire')) {
          drawText('x', 76, 298, 19)
        }
        if (reasons.includes('missions')) {
          drawText('x', 76, 260, 19)
        }
        let locationSize = idealFontSize(font, profile.town, 83, 7, 11)

        if (!locationSize) {
          alert('Le nom de la ville risque de ne pas Ãªtre affichÃ© correctement en raison de sa longueur. ' +
            'Essayez d\'utiliser des abrÃ©viations ("Saint" en "St." par exemple) quand cela est possible.')
          locationSize = 7
        }

        drawText(profile.town, 111, 226, locationSize)

        if (reasons !== '') {
          // Date sortie
          drawText(`${profile.datesortie}`, 92, 200)
          drawText(releaseHours, 200, 201)
          drawText(releaseMinutes, 220, 201)
        }

        // Date crÃ©ation
        drawText('Date de création:', 464, 150, 7)
        drawText(`${creationDate} Ã  ${creationHour}`, 455, 144, 7)

        const generatedQR = await generateQR(data)

        const qrImage = await pdfDoc.embedPng(generatedQR)

        page1.drawImage(qrImage, {
          x: page1.getWidth() - 170,
          y: 155,
          width: 100,
          height: 100,
        })

        pdfDoc.addPage()
        const page2 = pdfDoc.getPages()[1]
        page2.drawImage(qrImage, {
          x: 50,
          y: page2.getHeight() - 350,
          width: 300,
          height: 300,
        })

        const pdfBytes = await pdfDoc.save()

        return new Blob([pdfBytes], { type: 'application/pdf' })
      }

      function downloadBlob (blob, fileName) {
        const link = document.createElement('a')
        var url = URL.createObjectURL(blob)
        link.href = url
        link.download = fileName
        document.body.appendChild(link)
        link.click()
      }

      function getAndSaveReasons () {
        const values = $$('input[name="field-reason"]:checked')
          .map(x => x.value)
          .join('-')
        localStorage.setItem('reasons', values)
        return values
      }

      // see: https://stackoverflow.com/a/32348687/1513045
      function isFacebookBrowser () {
        const ua = navigator.userAgent || navigator.vendor || window.opera
        return ua.includes('FBAN') || ua.includes('FBAV')
      }

      if (isFacebookBrowser()) {
        $('#alert-facebook').classList.remove('d-none')
      }

      function addSlash () {
        this.value = this.value.replace(/^(\d{2})$/g, '$1/')
        this.value = this.value.replace(/^(\d{2})\/(\d{2})$/g, '$1/$2/')
      }

      $('#field-birthday').addEventListener('keyup', addSlash)

      const snackbar = $('#snackbar')

      $('#form-profile').addEventListener('submit', async event => {
        event.preventDefault()

        saveProfile()
        const reasons = getAndSaveReasons()
        const pdfBlob = await generatePdf(getProfile(), reasons)
        downloadBlob(pdfBlob, 'attestation.pdf')

        snackbar.classList.remove('d-none')
        setTimeout(() => snackbar.classList.add('show'), 100)

        setTimeout(function () {
          snackbar.classList.remove('show')
          setTimeout(() => snackbar.classList.add('d-none'), 500)
        }, 6000)
      })

      $('#set-defaults').addEventListener('click', async event => {
        setPerson();
      })

      $('#set-location').addEventListener('click', setLocation)

      $$('input').forEach(input => {
        const exempleElt = input.parentNode.parentNode.querySelector('.exemple')
        if (input.placeholder && exempleElt) {
          input.addEventListener('input', (event) => {
            if (input.value) {
              exempleElt.innerHTML = 'ex.&nbsp;: ' + input.placeholder
            } else {
              exempleElt.innerHTML = ''
            }
          })
        }
      })

      function addVersion () {
        document.getElementById('version').innerHTML = `${new Date().getFullYear()} - ${process.env.VERSION}`
      }
    </script>
</html>
